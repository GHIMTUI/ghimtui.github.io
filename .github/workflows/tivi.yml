name: Check IPTV Links

on:
  schedule:
    # Chạy mỗi 5-10 phút (tùy vào độ trễ của GitHub)
    - cron: '*/10 * * * *'
  workflow_dispatch: # Cho phép nhấn nút chạy thủ công

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Run link checker script
        run: |
          python - <<EOF
          import requests
          import re

          def check_link(url):
              try:
                  # Chỉ lấy header để tiết kiệm băng thông, timeout 5s
                  response = requests.head(url, timeout=5, allow_redirects=True)
                  return response.status_code == 200
              except:
                  return False

          with open('tivi.m3u', 'r', encoding='utf-8') as f:
              lines = f.readlines()

          new_content = []
          header = lines[0] if lines[0].startswith('#EXTM3U') else '#EXTM3U\n'
          new_content.append(header)

          # Duyệt qua từng cặp dòng (thông tin kênh và link)
          for i in range(len(lines)):
              if lines[i].startswith('#EXTINF'):
                  info = lines[i]
                  url = lines[i+1].strip() if (i+1) < len(lines) else ""
                  
                  if url and check_link(url):
                      new_content.append(info)
                      new_content.append(url + '\n')
                      print(f"✅ Live: {url}")
                  else:
                      print(f"❌ Dead/Skipped: {url}")

          with open('tivi.m3u', 'w', encoding='utf-8') as f:
              f.writelines(new_content)
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tivi.m3u
          if git commit -m "Auto-update: Clean dead links" ; then
            git push
          else
            echo "No changes to commit"
          fi
