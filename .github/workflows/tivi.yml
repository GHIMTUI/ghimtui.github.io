name: Tối ưu danh sách kênh
on:
  schedule:
    - cron: '0 */2 * * *' # Tự động chạy mỗi 2 tiếng
  workflow_dispatch:      # Cho phép bạn bấm nút chạy ngay lập tức

jobs:
  update-list:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run Script
        run: |
          python <<EOF
          import requests

          # Cấu hình danh sách link cho An Giang 1
          # Link nào đứng trước sẽ được ưu tiên kiểm tra trước
          list_agiang1 = [
              "http://tv.angiangtv.vn/live/kgtv/kgtv.m3u8",
              "http://live.fptplay53.net/epzsd1/angiang01_hls.smil/chunklist_b2500000.m3u8"
          ]

          def check_link(urls):
              for url in urls:
                  try:
                      # Kiểm tra phản hồi từ server trong 5 giây
                      r = requests.head(url, timeout=5, allow_redirects=True)
                      if r.status_code == 200:
                          return url
                  except:
                      continue
              return urls[0] # Nếu hỏng hết thì mặc định lấy link đầu tiên

          # Chọn link tốt nhất
          final_link = check_link(list_agiang1)

          # Nội dung file M3U (Chỉ có 1 kênh duy nhất)
          content = f"""#EXTM3U

#--- AN GIANG (MN) ---
#EXTINF:-1 tvg-id="angiang1" tvg-logo="http://ghimtui.github.io/logo/angiang1.png", An Giang 1
{final_link}
"""
          # Ghi vào file tivi.m3u
          with open("tivi.m3u", "w", encoding="utf-8") as f:
              f.write(content)
          EOF

      - name: Push update
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "IPTV-Bot"
          git add tivi.m3u
          git commit -m "Cập nhật link An Giang 1 mới nhất" || exit 0
          git push
