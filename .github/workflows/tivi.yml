name: Check M3U Links

on:
  schedule:
    - cron: '0 */1 * * *' # Chạy 1 tiếng một lần
  workflow_dispatch: # Cho phép chạy thủ công bằng tay

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get install -y curl

      - name: Check M3U links and Notify
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Đọc file m3u, lấy tên kênh và link
          # Giả định cấu hình: #EXTINF:-1,Kênh A [xuống dòng] link
          
          while IFS= read -r line; do
            if [[ $line == "#EXTINF"* ]]; then
              # Trích xuất tên kênh sau dấu phẩy
              channel_name=$(echo "$line" | sed 's/.*,//')
              
              # Đọc dòng tiếp theo để lấy URL
              read -r url
              
              # Kiểm tra link với curl (timeout 10s)
              status_code=$(curl -o /dev/null -s -w "%{http_code}" --max-time 10 "$url")
              
              if [ "$status_code" -ne 200 ]; then
                message="Kênh ${channel_name} không hoạt động! (Status: ${status_code})"
                echo "Sending alert for $channel_name"
                
                # Gửi thông báo qua Telegram
                curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
                  -d "chat_id=${TELEGRAM_CHAT_ID}" \
                  -d "text=${message}"
              fi
            fi
          done < tivi.m3u
