name: Check M3U Links

on:
  schedule:
    - cron: '0 */1 * * *' # Ki·ªÉm tra ƒë·ªãnh k·ª≥ m·ªói 6 ti·∫øng
  workflow_dispatch: # Cho ph√©p b·∫°n b·∫•m n√∫t ch·∫°y th·ªß c√¥ng b·∫•t c·ª© l√∫c n√†o

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: R√† so√°t danh s√°ch k√™nh
        run: |
          failed_list=""
          count=0
          
          # ƒê·ªçc file tivi.m3u (ch·ªâ ƒë·ªçc, kh√¥ng ghi)
          while IFS= read -r line; do
            if [[ $line == "#EXTINF"* ]]; then
              channel_name=$(echo "$line" | sed 's/.*,//' | tr -d '\r')
              read -r url
              url=$(echo "$url" | tr -d '\r')
              
              # Th·ª≠ k·∫øt n·ªëi t·ªõi link (ch·ªù t·ªëi ƒëa 5 gi√¢y)
              status_code=$(curl -o /dev/null -s -w "%{http_code}" --max-time 5 "$url")
              
              if [ "$status_code" -ne 200 ]; then
                # N·∫øu l·ªói, th√™m t√™n k√™nh v√†o danh s√°ch t·∫°m
                if [ $count -eq 0 ]; then
                  failed_list="$channel_name"
                else
                  failed_list="$failed_list, $channel_name"
                fi
                count=$((count+1))
              fi
            fi
          done < tivi.m3u

          # Xu·∫•t b√°o c√°o ra GitHub Summary
          echo "### üìä B√°o c√°o r√† so√°t k√™nh" >> $GITHUB_STEP_SUMMARY
          
          if [ $count -eq 0 ]; then
            echo "‚úÖ **K√™nh tivi ·ªïn ƒë·ªãnh!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **K√™nh $failed_list kh√¥ng ho·∫°t ƒë·ªông!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> T·ªïng c·ªông ph√°t hi·ªán $count k√™nh g·∫∑p s·ª± c·ªë." >> $GITHUB_STEP_SUMMARY
          fi
