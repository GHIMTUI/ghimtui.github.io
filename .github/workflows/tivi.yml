name: Check M3U Links

on:
  schedule:
    - cron: '0 */0.5 * * *'
  workflow_dispatch:

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check M3U links and Update Summary
        run: |
          failed_channels=""
          count=0
          
          # ƒê·ªçc file tivi.m3u
          while IFS= read -r line; do
            if [[ $line == "#EXTINF"* ]]; then
              channel_name=$(echo "$line" | sed 's/.*,//' | tr -d '\r')
              read -r url
              url=$(echo "$url" | tr -d '\r')
              
              # Ki·ªÉm tra link (timeout 5s)
              status_code=$(curl -o /dev/null -s -w "%{http_code}" --max-time 5 "$url")
              
              if [ "$status_code" -ne 200 ]; then
                failed_channels="${failed_channels}\n- **${channel_name}** (M√£ l·ªói: ${status_code})"
                count=$((count+1))
              fi
            fi
          done < tivi.m3u

          # Ghi k·∫øt qu·∫£ tr·ª±c ti·∫øp v√†o GitHub Summary (Markdown h·ªó tr·ª£)
          echo "## üì∫ K·∫øt qu·∫£ ki·ªÉm tra IPTV" >> $GITHUB_STEP_SUMMARY
          echo "C·∫≠p nh·∫≠t l√∫c: $(date +'%H:%M - %d/%m/%Y')" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          
          if [ $count -eq 0 ]; then
            echo "‚úÖ **K√™nh tivi ·ªïn ƒë·ªãnh!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **K√™nh $count kh√¥ng ho·∫°t ƒë·ªông!**" >> $GITHUB_STEP_SUMMARY
            echo -e "$failed_channels" >> $GITHUB_STEP_SUMMARY
          fi
