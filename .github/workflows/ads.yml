name: Auto Sort and Merge Ads List
on:
  push:
    paths:
      - 'z-ads/ads.txt'

permissions:
  contents: write

jobs:
  sort-and-clean:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process Ads File (Sort & Merge)
        id: process_step
        shell: python
        run: |
          import re
          import os

          file_path = "z-ads/ads.txt"
          if not os.path.exists(file_path):
              print("File not found")
              exit(0)

          with open(file_path, 'r', encoding='utf-8') as f:
              lines = f.readlines()

          original_count = len(lines)
          headers = [l for l in lines if l.startswith(('!', '['))]
          body = [l.strip() for l in lines if l.strip() and not l.startswith(('!', '['))]

          # 1. Loại bỏ trùng lặp tuyệt đối & Sắp xếp
          body = sorted(list(set(body)))

          # 2. Logic Gộp các bộ lọc có đuôi số/chữ hỗn hợp
          # Quy tắc: Nếu nhiều dòng bắt đầu bằng "abc-" thì gộp thành "abc-*" hoặc giữ nguyên tùy mục đích.
          # Ở đây ta sẽ dùng Regex để tìm phần gốc trước dấu gạch ngang cuối cùng
          merged_body = []
          seen_prefixes = {}

          for line in body:
              # Tìm phần gốc: ví dụ "a-1" -> "a-", "a-rrtt3rtt" -> "a-"
              # Regex này cắt ở dấu gạch ngang cuối cùng nếu sau đó là hỗn hợp số/chữ
              match = re.match(r'^(.+?)-[a-zA-Z0-9]+$', line)
              if match:
                  prefix = match.group(1)
                  if prefix not in seen_prefixes:
                      seen_prefixes[prefix] = []
                  seen_prefixes[prefix].append(line)
              else:
                  merged_body.append(line)

          # Xử lý các nhóm đã gộp
          for prefix, variants in seen_prefixes.items():
              if len(variants) > 3: # Nếu có hơn 3 biến thể thì gộp thành tiền tố chung
                  merged_body.append(f"{prefix}-*")
              else:
                  merged_body.extend(variants)

          # Sắp xếp lại lần cuối và ghi file
          final_body = sorted(list(set(merged_body)))
          with open(file_path, 'w', encoding='utf-8') as f:
              f.writelines(headers)
              f.write('\n'.join(final_body) + '\n')

          removed_count = original_count - (len(headers) + len(final_body))
          with open(os.environ['GITHUB_OUTPUT'], 'a') as a:
              a.write(f"removed_count={removed_count}\n")

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Bot: Sắp xếp & Gộp bộ lọc (Xoá ${{ steps.process_step.outputs.removed_count }} dòng)"
          file_pattern: 'z-ads/ads.txt'
