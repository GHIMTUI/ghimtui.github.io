name: Standardize ads.txt

on:
  push:
    paths:
      - 'z-ads/ads.txt'
  workflow_dispatch:

jobs:
  format-ads:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process ads.txt
        shell: python
        run: |
          import re
          import os

          file_path = "z-ads/ads.txt"
          
          if not os.path.exists(file_path):
              print("File kh√¥ng t·ªìn t·∫°i!")
              exit(0)

          # 1. ƒê·ªçc d·ªØ li·ªáu
          with open(file_path, 'r', encoding='utf-8') as f:
              raw_lines = f.readlines()

          header_lines = []
          ad_records = set()

          for line in raw_lines:
              clean = line.strip()
              if not clean:
                  continue
              
              # T√°ch c√°c d√≤ng Header ƒë·∫∑c bi·ªát (v√≠ d·ª•: [Adblock Plus 2.0] ho·∫∑c d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng #)
              if clean.startswith('[') or clean.startswith('#'):
                  # N·∫øu l√† header, l∆∞u v√†o danh s√°ch header ƒë·ªÉ gi·ªØ ·ªü ƒë·∫ßu file
                  header_lines.append(clean)
              else:
                  # X·ª≠ l√Ω chu·∫©n h√≥a b·∫£n ghi ads
                  # Lo·∫°i b·ªè www. ·ªü ƒë·∫ßu ho·∫∑c sau d·∫•u ph·∫©y
                  record = re.sub(r'^www\.', '', clean)
                  record = re.sub(r',\s*www\.', ', ', record)
                  ad_records.add(record)

          # 2. S·∫Øp x·∫øp danh s√°ch b·∫£n ghi ads
          unique_ads = sorted(list(ad_records), key=lambda s: s.lower())

          # 3. Ph√¢n nh√≥m v√† t·∫°o kho·∫£ng tr·ªëng cho ph·∫ßn ads
          organized_ads = []
          last_group = None

          for line in unique_ads:
              # L·∫•y k√Ω t·ª± ƒë·∫ßu ƒë·ªÉ ph√¢n nh√≥m (0-9 ho·∫∑c a-z)
              first_char = line[0].lower()
              current_group = '0-9' if first_char.isdigit() else first_char
              
              if last_group is not None and last_group != current_group:
                  organized_ads.append('') # Th√™m d√≤ng tr·ªëng khi ƒë·ªïi nh√≥m
              
              organized_ads.append(line)
              last_group = current_group

          # 4. G·ªôp Header v√† Ads ƒë√£ s·∫Øp x·∫øp
          # ƒê·∫£m b·∫£o header n·∫±m tr√™n c√πng, sau ƒë√≥ l√† 1 d√≤ng tr·ªëng, r·ªìi ƒë·∫øn ads
          final_content = header_lines + ([''] if header_lines and organized_ads else []) + organized_ads

          # 5. Ghi l·∫°i v√†o file
          with open(file_path, 'w', encoding='utf-8') as f:
              f.write('\n'.join(final_content).strip() + '\n')

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üòä s·∫Øp x·∫øp b·ªô l·ªçc th√†nh c√¥ng!"
          file_pattern: 'z-ads/ads.txt'
