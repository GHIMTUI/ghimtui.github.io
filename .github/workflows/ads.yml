name: Tự động sắp xếp
on:
  push:
    paths:
      - 'z-ads/ads.txt'

permissions:
  contents: write

jobs:
  sort-and-clean:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Process Ads File
        id: process_step
        run: |
          FILE_PATH="z-ads/ads.txt"
          
          # Kiểm tra nếu tệp tồn tại
          if [ ! -f "$FILE_PATH" ]; then
            echo "File not found!"
            exit 0
          fi
          
          # Đếm số dòng ban đầu
          ORIGINAL_COUNT=$(wc -l < "$FILE_PATH")
          
          # Tách Header (các dòng bắt đầu bằng ! hoặc [)
          grep -E "^!|^\[" "$FILE_PATH" > header.tmp || touch header.tmp
          
          # Xử lý Body:
          # 1. Loại bỏ các dòng header
          # 2. Xóa khoảng trắng cuối dòng
          # 3. Loại bỏ tiền tố 'www.' ở đầu dòng (nếu có)
          # 4. Loại bỏ các dòng trống
          # 5. Sắp xếp và loại bỏ trùng lặp (sort -u)
          grep -vE "^!|^\[" "$FILE_PATH" | \
          sed 's/[[:space:]]*$//' | \
          sed 's/^www\.//g' | \
          grep . | \
          sort -u > sorted_body.tmp
          
          # Gộp lại Header và Body đã xử lý
          cat header.tmp sorted_body.tmp > "$FILE_PATH"
          
          # Đếm số dòng sau khi xử lý
          FINAL_COUNT=$(wc -l < "$FILE_PATH")
          REMOVED_COUNT=$((ORIGINAL_COUNT - FINAL_COUNT))
          
          echo "Original: $ORIGINAL_COUNT"
          echo "Final: $FINAL_COUNT"
          echo "Removed: $REMOVED_COUNT"

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-clean: Remove www prefix, sort and deduplicate ads.txt"
          file_pattern: 'z-ads/ads.txt'
