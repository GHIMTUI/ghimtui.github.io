name: ads.txt

on:
  push:
    paths:
      - 'z-ads/ads.txt'
  workflow_dispatch:

jobs:
  format-ads:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process ads.txt
        shell: python
        run: |
          import re, os
          from pathlib import Path
          from collections import defaultdict

          file_path = Path("z-ads/ads.txt")
          if not file_path.exists(): exit(0)

          lines = file_path.read_text(encoding='utf-8').splitlines()
          
          headers, grouped_rules, other_rules = [], defaultdict(set), set()
          bad_pfx = r'^(www\.|m\.|dev\.|staging\.|api\.)'

          for line in map(str.strip, lines):
              if not line: continue
              if line.startswith(('[', '#')):
                  headers.append(line)
                  continue

              # Xử lý gộp link: domain##selector
              match = re.match(r'^([^#]+)(##|#@#)(.+)$', line)
              if match:
                  dom, sep, sel = match.groups()
                  clean_dom = re.sub(bad_pfx, '', dom)
                  # Gộp các selector vào set để tự loại trùng
                  grouped_rules[f"{clean_dom}{sep}"].update(s.strip() for s in sel.split(','))
              else:
                  # Rule khác: ||example.com^
                  rec = re.sub(bad_pfx, '', line)
                  rec = re.sub(r',\s*' + bad_pfx, ', ', rec)
                  other_rules.add(rec)

          # Format lại các rule đã gộp
          formatted = [f"{k}{', '.join(sorted(v))}" for k, v in grouped_rules.items()]
          all_rules = sorted(formatted + list(other_rules), 
                            key=lambda s: ('{~~}' if s.startswith('@@||') else '{~}' if s.startswith('||') else '') + s.lower())

          # Tổ chức nhóm và chèn dòng trống
          final_ads, last_grp = [], None
          for line in all_rules:
              grp = 'EX' if line.startswith('@@||') else 'BL' if line.startswith('||') else line[0].lower()
              if last_grp and last_grp != grp:
                  final_ads.append('')
              final_ads.append(line)
              last_grp = grp

          # Ghi file
          content = "\n".join(headers + ([''] if headers and final_ads else []) + final_ads)
          file_path.write_text(content.strip() + '\n', encoding='utf-8')

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-format: Grouped duplicate domains and sorted rules"
          file_pattern: 'z-ads/ads.txt'
