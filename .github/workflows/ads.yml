name: Auto Sort Ads List
on:
  push:
    paths:
      - 'z-ads/ads.txt'

permissions:
  contents: write

jobs:
  sort-and-clean:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Process Ads File
        id: count
        run: |
          FILE="z-ads/ads.txt"
          BEFORE=$(wc -l < "$FILE")
          
          # Tách header, lọc trùng và sắp xếp body
          grep -E "^!|^\[" "$FILE" > h.tmp || touch h.tmp
          grep -vE "^!|^\[" "$FILE" | sed 's/[[:space:]]*$//' | grep . | sort -u > b.tmp
          cat h.tmp b.tmp > "$FILE"
          
          AFTER=$(wc -l < "$FILE")
          echo "diff=$((BEFORE - AFTER))" >> $GITHUB_OUTPUT
          rm h.tmp b.tmp

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Sắp xếp & xoá ${{ steps.count.outputs.diff }} dòng!"
          file_pattern: 'z-ads/ads.txt'
