name: Standardize ads.txt

on:
  push:
    paths:
      - 'z-ads/ads.txt'
  workflow_dispatch:

jobs:
  format-ads:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process ads.txt
        shell: python
        run: |
          import re
          import os

          file_path = "z-ads/ads.txt"
          
          if not os.path.exists(file_path):
              print("File kh√¥ng t·ªìn t·∫°i!")
              exit(0)

          with open(file_path, 'r', encoding='utf-8') as f:
              raw_lines = f.readlines()

          header_lines = []
          ad_records = set()

          for line in raw_lines:
              clean = line.strip()
              if not clean:
                  continue
              
              if clean.startswith('[') or clean.startswith('#'):
                  header_lines.append(clean)
              else:
                  # --- PH·∫¶N THAY ƒê·ªîI CH√çNH ---
                  # Regex n√†y s·∫Ω t√¨m c√°c ti·ªÅn t·ªë nh∆∞ m., dev., www. v√† lo·∫°i b·ªè ch√∫ng
                  # N√≥ gi·ªØ l·∫°i ph·∫ßn domain ch√≠nh (v√≠ d·ª•: google.com, doubleclick.net)
                  
                  # 1. X·ª≠ l√Ω ƒë·∫ßu d√≤ng: Lo·∫°i b·ªè ti·ªÅn t·ªë ƒë·ª©ng tr∆∞·ªõc domain ch√≠nh
                  # T√¨m c√°c chu·ªói k·∫øt th√∫c b·∫±ng d·∫•u ch·∫•m nh∆∞ng kh√¥ng ph·∫£i ph·∫ßn m·ªü r·ªông cu·ªëi c√πng
                  # V√≠ d·ª•: m.google.com -> google.com
                  record = re.sub(r'^(?:[a-zA-Z0-9-]+\.)+(?=[a-zA-Z0-9-]+\.[a-z]{2,})', '', clean)
                  
                  # 2. X·ª≠ l√Ω sau d·∫•u ph·∫©y (n·∫øu c√≥ tr∆∞·ªùng h·ª£p ghi domain ·ªü v·ªã tr√≠ kh√°c - hi·∫øm g·∫∑p trong ads.txt ti√™u chu·∫©n)
                  record = re.sub(r',\s*(?:[a-zA-Z0-9-]+\.)+(?=[a-zA-Z0-9-]+\.[a-z]{2,})', ', ', record)
                  # ---------------------------
                  
                  ad_records.add(record)

          # S·∫Øp x·∫øp
          unique_ads = sorted(list(ad_records), key=lambda s: s.lower())

          # Ph√¢n nh√≥m
          organized_ads = []
          last_group = None

          for line in unique_ads:
              if not line: continue
              first_char = line[0].lower()
              current_group = '0-9' if first_char.isdigit() else first_char
              
              if last_group is not None and last_group != current_group:
                  organized_ads.append('')
              
              organized_ads.append(line)
              last_group = current_group

          final_content = header_lines + ([''] if header_lines and organized_ads else []) + organized_ads

          with open(file_path, 'w', encoding='utf-8') as f:
              f.write('\n'.join(final_content).strip() + '\n')

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üòä ƒêang s·∫Øp x·∫øp!"
          file_pattern: 'z-ads/ads.txt'
