name: Tạm Dừng Quảng Cáo
on:
  push:
    paths:
      - 'z-ads/ads.txt'

permissions:
  contents: write

jobs:
  sort-and-clean:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Process Ads File
        id: process_step
        run: |
          FILE="z-ads/ads.txt"
          
          # 1. Tách Header và Body (loại bỏ tiền tố http/www, chuyển chữ thường, sort duy nhất)
          grep -E "^! \[|^\[" "$FILE" > header.tmp || true
          grep -vE "^!|^\[" "$FILE" | sed -E 's|^(https?://)?(www\.)?||g' | tr '[:upper:]' '[:lower:]' | sort -u > body.tmp
          
          # 2. Dùng AWK để phân nhóm A-Z và chèn tiêu đề nhóm
          awk '{
            char = substr($0, 1, 1);
            group = (char ~ /[0-9]/) ? "#" : toupper(char);
            if (group != last) {
              print "\n! " group;
              last = group;
            }
            print $0;
          }' body.tmp > final_body.tmp

          # 3. Gộp lại và ghi đè file gốc
          cat header.tmp final_body.tmp | sed '/./,/^$/!d' > "$FILE"
          
          # 4. Tính toán thông số
          ORIGINAL=$(grep -vE "^!|^\[" "$FILE" | wc -l)
          FINAL=$(wc -l < body.tmp)
          echo "msg=Dòng cũ: $ORIGINAL | Sau khi lọc: $FINAL | Đã xóa: $((ORIGINAL - FINAL))" >> $GITHUB_OUTPUT
          rm *.tmp

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Bot: ${{ steps.process_step.outputs.msg }}"
          file_pattern: 'z-ads/ads.txt'
