name: Standardize ads.txt

on:
  push:
    paths:
      - 'z-ads/ads.txt'
  workflow_dispatch:

jobs:
  format-ads:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process ads.txt
        shell: python
        run: |
          import re
          import os

          file_path = "z-ads/ads.txt"
          
          if not os.path.exists(file_path):
              print("File không tồn tại!")
              exit(0)

          with open(file_path, 'r', encoding='utf-8') as f:
              raw_lines = f.readlines()

          header_lines = []
          ad_records = set()
          # Danh sách các tiền tố rác cần loại bỏ
          bad_prefixes = r'^(www\.|m\.|dev\.|staging\.|api\.)'

          for line in raw_lines:
              clean = line.strip()
              if not clean: continue
              
              if clean.startswith('[') or clean.startswith('#'):
                  header_lines.append(clean)
              else:
                  # Xóa tiền tố ở đầu dòng
                  record = re.sub(bad_prefixes, '', clean)
                  # Xóa tiền tố sau dấu phẩy (nếu có)
                  record = re.sub(r',\s*' + bad_prefixes, ', ', record)
                  ad_records.add(record)

          unique_ads = sorted(list(ad_records), key=lambda s: s.lower())
          organized_ads = []
          last_group = None

          for line in unique_ads:
              if not line: continue
              first_char = line[0].lower()
              current_group = '0-9' if first_char.isdigit() else first_char
              if last_group is not None and last_group != current_group:
                  organized_ads.append('')
              organized_ads.append(line)
              last_group = current_group

          final_content = header_lines + ([''] if header_lines and organized_ads else []) + organized_ads

          with open(file_path, 'w', encoding='utf-8') as f:
              f.write('\n'.join(final_content).strip() + '\n')

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Fixed: Safely removed prefixes while keeping .com.vn domains"
          file_pattern: 'z-ads/ads.txt'
