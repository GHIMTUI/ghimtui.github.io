name: Standardize ads.txt

on:
  push:
    paths:
      - 'z-ads/ads.txt'
  workflow_dispatch:

jobs:
  format-ads:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process ads.txt
        shell: python
        run: |
          import re
          import os

          file_path = "z-ads/ads.txt"
          
          if not os.path.exists(file_path):
              print("File không tồn tại!")
              exit(0)

          with open(file_path, 'r', encoding='utf-8') as f:
              raw_lines = f.read().splitlines()

          header_lines = []
          ad_records = set()
          
          # Regex gộp: Khớp ở đầu dòng (^) hoặc sau dấu phẩy (,\s*)
          # Chỉ loại bỏ các tiền tố rác cụ thể, giữ nguyên phần còn lại (như .com.vn)
          bad_prefixes_pattern = r'(^|,\s*)(www\.|m\.|dev\.|staging\.|api\.)'

          for line in raw_lines:
              clean = line.strip()
              if not clean:
                  continue
              
              # Tách riêng các dòng chú thích hoặc cấu trúc đặc biệt [ ]
              if clean.startswith(('[', '#')):
                  header_lines.append(clean)
              else:
                  # Sử dụng \1 để giữ lại cấu trúc phân cách (đầu dòng hoặc dấu phẩy)
                  # và loại bỏ tiền tố rác đứng ngay sau nó.
                  record = re.sub(bad_prefixes_pattern, r'\1', clean)
                  ad_records.add(record)

          # Sắp xếp theo bảng chữ cái (không phân biệt hoa thường)
          unique_ads = sorted(list(ad_records), key=lambda s: s.lower())
          
          organized_ads = []
          last_group = None

          for line in unique_ads:
              if not line: continue
              # Xác định nhóm để chèn dòng trống (A, B, C... hoặc 0-9)
              first_char = line[0].lower()
              current_group = '0-9' if first_char.isdigit() else first_char
              
              if last_group is not None and last_group != current_group:
                  organized_ads.append('')
              
              organized_ads.append(line)
              last_group = current_group

          # Hợp nhất Header và nội dung đã xử lý
          final_content = "\n".join(header_lines)
          if header_lines and organized_ads:
              final_content += "\n\n"
          final_content += "\n".join(organized_ads)

          with open(file_path, 'w', encoding='utf-8') as f:
              f.write(final_content.strip() + '\n')

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Optimization: Standardized domains and removed redundant prefixes"
          file_pattern: 'z-ads/ads.txt'
