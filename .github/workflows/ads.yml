name: Standardize ads.txt

on:
  push:
    paths:
      - 'z-ads/ads.txt'
  workflow_dispatch:

jobs:
  format-ads:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process ads.txt
        shell: python
        run: |
          import re
          from pathlib import Path
          from collections import defaultdict

          file_path = Path("z-ads/ads.txt")
          if not file_path.exists():
              print("File not found, skipping...")
              exit(0)

          # Regex tìm các prefix không mong muốn ở bất kỳ vị trí nào (\b là word boundary)
          bad_pfx = r'\b(www\.|m\.|dev\.|staging\.|api\.)'
          
          lines = file_path.read_text(encoding='utf-8').splitlines()
          headers, grouped_rules, other_rules = [], defaultdict(set), set()

          for line in map(str.strip, lines):
              if not line: continue
              # Lưu comment và block header
              if line.startswith(('[', '#')):
                  headers.append(line)
                  continue

              # Tách domain và selector: (domains)(##|#@#)(selectors)
              match = re.match(r'^([^#]+)(##|#@#)(.+)$', line)
              if match:
                  domains_str, separator, selector_str = match.groups()
                  
                  # 1. Làm sạch và gộp domain (tách bằng dấu phẩy)
                  clean_doms = {re.sub(bad_pfx, '', d.strip()) for d in domains_str.split(',')}
                  # Sắp xếp domain để key luôn nhất quán (a,b## giống b,a##)
                  domain_key = ",".join(sorted(clean_doms))
                  
                  # 2. Tách và làm sạch selector
                  new_selectors = {s.strip() for s in selector_str.split(',')}
                  
                  # 3. Gộp vào dict theo cặp (domain_key, separator)
                  grouped_rules[(domain_key, separator)].update(new_selectors)
              else:
                  # Xử lý các rule khác như ||example.com^ hoặc @@||...
                  # Loại bỏ prefix thừa cho cả domain đơn lẻ
                  record = re.sub(bad_pfx, '', line)
                  # Xử lý trường hợp có dấu phẩy trong rule (nếu có)
                  record = re.sub(r',\s*' + bad_pfx, ', ', record)
                  other_rules.add(record)

          # Tạo danh sách rule đã định dạng
          formatted_grouped = [
              f"{doms}{sep}{', '.join(sorted(sels))}" 
              for (doms, sep), sels in grouped_rules.items()
          ]
          
          # Sắp xếp toàn bộ rules
          def sort_logic(s):
              s_low = s.lower()
              if s_low.startswith('@@||'): return '{~~}' + s_low  # Xuống cuối cùng
              if s_low.startswith('||'): return '{~}' + s_low    # Xuống gần cuối
              return s_low

          all_ads = sorted(formatted_grouped + list(other_rules), key=sort_logic)

          # Tổ chức nhóm và chèn dòng trống để dễ đọc
          organized_ads, last_group = [], None
          for line in all_ads:
              if line.startswith('@@||'):
                  current_group = 'EXCLUDE'
              elif line.startswith('||'):
                  current_group = 'BLOCK'
              else:
                  # Nhóm theo chữ cái đầu tiên của domain
                  current_group = line[0].lower()

              if last_group is not None and last_group != current_group:
                  organized_ads.append('')
              
              organized_ads.append(line)
              last_group = current_group

          # Hợp nhất Header và Body
          final_content = headers + ([''] if headers and organized_ads else []) + organized_ads
          
          # Ghi lại vào file
          file_path.write_text('\n'.join(final_content).strip() + '\n', encoding='utf-8')

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-format: Standardized domains and grouped selectors"
          file_pattern: 'z-ads/ads.txt'
